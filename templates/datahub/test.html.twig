{% extends 'web_base.html.twig' %}
{% block body %}

<div class="page-content condensed">
    <!-- BEGIN SAMPLE PORTLET CONFIGURATION MODAL FORM-->
    <div id="portlet-config" class="modal hide">
        <div class="modal-header">
            <button data-dismiss="modal" class="close" type="button"></button>
            <h3>Widget Settings</h3>
        </div>
        <div class="modal-body"> Widget settings form goes here </div>
        </div>
        <div class="clearfix"></div>
        <div class="content">
            <ul class="breadcrumb">
            </ul>
            <div class="page-title"> 
                <h3>MITHUB - <span class="semi-bold">Datapool</span></h3>
            </div>
            <div class="row-fluid">
                <div class="span12">
                    <div class="grid simple ">
                        <div class="grid-title">
                            <h4>Datapool <span class="semi-bold"></span></h4>
                            
                            <!--
                            <div class="tools">
                                <a href="javascript:;" class="collapse"></a>
                                <a href="#grid-config" data-toggle="modal" class="config"></a>
                                <a href="javascript:;" class="reload"></a>
                                <a href="javascript:;" class="remove"></a>
                            </div>
                            -->
                        </div>
                        <div class="grid-body ">
                            <button class="btn btn-primary"data-toggle="modal" data-target="#upload-data"  style="margin-bottom:10px;" >Upload Data</button>
                            <table class="table" id="example3">
                                <thead>
                                    <tr>
                                        <th>Upload Id</th>
                                        <th>Uploader</th>
                                        <th>Total Data</th>
                                        <th>Data Type</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for upload in uploads %}
                                    <tr>
                                        {% if upload.datatype != 'image' %}
                                        <td><a href="/datahub/list_new?uploadId={{upload.uploadId}}">{{upload.uploadId}}</td>
                                        {% endif %}
                                        {% if upload.datatype == 'image' %}
                                        <td><a href="redirect_image?uploadId={{upload.uploadId}}">{{upload.uploadId}}</td>
                                        {% endif %}
                                        <td>{{upload.email}}</td>
                                        <td>{{upload.totalData}}</td>
                                        <td>{{upload.datatype}}</td>
                                        <td>{{upload.date}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="rightbar-overlay"></div>
        <input type="text" id="uploadData" style="display:none;"></input>
        <input type="text" id="headerData" style="display:none;"></input>
         <input type="text" id="uniqueId" style="display:none;"></input>
         <input type="text" id="current-batch" value="0" style="display:none;"></input>
	  
	<!-- SIDEBAR -->
    {{ include('default/web-rightbar.html.twig')}}
    <!-- END SIDEBAR -->

     {{ include('datahub/new_modal.html.twig') }}

      
    <!-- END CONTAINER -->
    <script src="https://oneanalytics.github.io/assetsweb/plugins/pace/pace.min.js" type="text/javascript"></script>
    <!-- BEGIN JS DEPENDECENCIES-->
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/bootstrapv3/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-block-ui/jqueryblockui.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-unveil/jquery.unveil.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-scrollbar/jquery.scrollbar.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-numberAnimate/jquery.animateNumbers.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-validation/js/jquery.validate.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/bootstrap-select2/select2.min.js" type="text/javascript"></script>
    <!-- END CORE JS DEPENDECENCIES-->
    <!-- BEGIN CORE TEMPLATE JS -->
    <script src="https://oneanalytics.github.io/webarch/js/webarch.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/js/chat.js" type="text/javascript"></script>
    <!-- END CORE TEMPLATE JS -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="https://oneanalytics.github.io/assetsweb/plugins/bootstrap-select2/select2.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-datatable/js/jquery.dataTables.min.js" type="text/javascript"></script>
    <script src="https://oneanalytics.github.io/assetsweb/plugins/jquery-datatable/extra/js/dataTables.tableTools.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://oneanalytics.github.io/assetsweb/plugins/datatables-responsive/js/datatables.responsive.js"></script>
    <script type="text/javascript" src="https://oneanalytics.github.io/assetsweb/plugins/datatables-responsive/js/lodash.min.js"></script>
    <!-- END PAGE LEVEL JS INIT -->
    <script src="https://oneanalytics.github.io/assetsweb/js/datatables.js" type="text/javascript"></script>
    <!-- END JAVASCRIPTS -->
   <!-- App js -->
    <script src="https://ajax.aspnetcdn.com/ajax/modernizr/modernizr-2.8.3.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/infragistics.core.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/infragistics.lob.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_core.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_collections.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_text.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_io.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_ui.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.documents.core_core.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_collectionsextended.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.excel_core.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_threading.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.ext_web.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.xml.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.documents.core_openxml.js"></script>
    <script type="text/javascript" src="https://cdn-na.infragistics.com/igniteui/2020.1/latest/js/modules/infragistics.excel_serialization_openxml.js"></script>
    <script>
    $('document').ready(function(){

        $('#form-upload').hide();
        $('#image-upload').hide();
        $('#txtArea').hide();
        $('#imageFooter').hide();

        var flag = 0;

        $("#dataTypeTxt").on("change", function(){
            if($("#dataTypeTxt").val() == 'txt')
            {
                flag = 2;
                $('#txtArea').show();
                $('#btnFooter').show();
                $('#form-upload').hide();
                $('#image-upload').hide();
                $('#imageFooter').hide();
                $('#btnFooter').prepend('</div>');

            }
            else if ($("#dataTypeTxt").val() == 'img')
            {
                $('#txtArea').hide();
                $('#btnFooter').hide();
                $('#image-upload').show(); 
                $('#form-upload').hide();
                $('#imageFooter').show();
            
            }
            else
            {
                $('#txtArea').hide();
                $('#btnFooter').show();
                $('#image-upload').hide(); 
                $('#form-upload').show();
                $('#imageFooter').hide();
            }
        });

        var form = document.getElementById('image-upload');
        form.onsubmit = function() {
            var fileInput = document.getElementById('import-audiences');
            var files = fileInput.files[0];
            var formData = new FormData();
            formData.append('files', files);
            var xhr = new XMLHttpRequest();
            // Add any event handlers here...
            xhr.open('POST', form.getAttribute('action'), true);
            xhr.send(formData);

            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    data = xhr.response;
                    console.log(data);

                }
            }        
            return false; // To avoid actual submission of the form
        }

        $("#import-audience").on("change", function () {
            $("#upload-id").css("display","none");
            $("#btn-upload-audience").css("display","none");
            var dataType = $("#dataTypeTxt").val();
            

            excelFile = this.files[0];
            console.log("Tes "+JSON.stringify(excelFile));
            console.log("data type "+dataType);

            if( dataType == 'xls'){
                    var excelFile,
                fileReader = new FileReader();
                var n = Math.floor(Math.random() * 11);
                var k = Math.floor(Math.random() * 1000000);
                var m = String.fromCharCode(n) + k;
                //$("#result").hide();
                fileReader.onload = function (e) {
                var buffer = new Uint8Array(fileReader.result);

                $.ig.excel.Workbook.load(buffer, function (workbook) {
                    //var column, row, newRow, cellValue, columnIndex, i,
                    var worksheet = workbook.worksheets(0);
                    var columnsNumber = 0;
                    var data = [];
                    var title = [];
                    var worksheetRowsCount;
                                    
                    while (worksheet.rows(0).getCellValue(columnsNumber)) {
                        columnsNumber++;
                    }

                    for (i = 0, worksheetRowsCount = worksheet.rows().count() ; i < worksheetRowsCount; i++) {
                        var newRow = [];
                        var titleRow = [];
                        var row = worksheet.rows(i);

                        if(i == 0){
                            for (columnIndex = 0; columnIndex < columnsNumber; columnIndex++) {
                                var cellValue = row.getCellText(columnIndex);
                                titleRow.push(cellValue);
                            }
                            title.push(titleRow)
                            
                        }else{
                            for (columnIndex = 0; columnIndex < columnsNumber; columnIndex++) {
                                var cellValue = row.getCellText(columnIndex);
                                newRow.push(cellValue);
                            }
                            data.push(newRow);
                            
                        }
                                        
                    }
                    $("#uploadData").val(JSON.stringify(data));
                    $("#headerData").val(JSON.stringify(title));
                    $("#uniqueId").val(k);
                    console.log("data "+data);
                    $("#btn-upload-audience").css("display","initial");
                }, function (error) {
                        $("#result").text("The excel file is corrupted.");
                        $("#result").show(1000);
                    })      
                }

                if(this.files.length > 0) {
                    excelFile = this.files[0];
                    if (excelFile.type === "application/vnd.ms-excel" || excelFile.type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" || (excelFile.type === "" && (excelFile.name.endsWith("xls") || excelFile.name.endsWith("xlsx")))) {
                        fileReader.readAsArrayBuffer(excelFile);
                    } else {
                        $("#result").text("The format of the file you have selected is not supported. Please select a valid Excel file ('.xls, *.xlsx').");
                        $("#result").show(1000);
                    }
                }


            }
        });

        $("#btn-upload-audience").click(function(){
            
            if (flag == 0 && flag != 2)
            {
                console.log("Test");
                var data = $("#uploadData").val();
                var objectData = JSON.parse(data);
                var headerData = $("#headerData").val();
                var objectHeaderData = JSON.parse(headerData);
                console.log("Object data "+objectData);
                console.log("Object data "+objectHeaderData);
            }
            
            readDataProcessing();

        });

    });

function readDataProcessing(){ 
    var dataType = $("#dataTypeTxt").val();
    if(dataType == "xls"){
        var data = $("#uploadData").val();
        var objectData = JSON.parse(data);
        var dataPush = [];
        var uniqueId = $("#uniqueId").val();
        var headerData = $("#headerData").val();
        var objectHeaderData = JSON.parse(headerData);

        $('#processing-data').modal({
            backdrop: 'static'
        });

        var batch = 0;
        var moduloBatch = objectData.length%50;
        var totalBatch = parseInt(objectData.length/50);
        if(moduloBatch > 0){
            totalBatch++;
        }
        saveUploadData(objectHeaderData, uniqueId, totalBatch, 0, "xls", "header", objectData.length);

        for(var x=0;x<objectData.length;x++){
            var currentValue = x+1; 
            
            if(currentValue % 50==0 || objectData.length == currentValue){
                console.log("datapush "+dataPush);
                batch++;
                dataPush.push(objectData[x]);
                if(objectData.length == currentValue){
                    var statusBatch = 1;
                    saveUploadData(dataPush, uniqueId, totalBatch, statusBatch, "", "field", objectData.length);

                }else{
                    var statusBatch = 0;
                    saveUploadData(dataPush, uniqueId, totalBatch, statusBatch, "", "field", objectData.length);

                }
            //console.log("detail data "+JSON.stringify(dataPush));
                
                dataPush = [];
            }else{
                dataPush.push(objectData[x])
            }
        }
    }else if(dataType == "txt"){
        var dataText = $('#txtTextArea').val();
        var data = [];
        var array2 = [];
        data.push(dataText);
        array2.push(data);
        var n = Math.floor(Math.random() * 11);
        var uniqueId = Math.floor(Math.random() * 1000000);

        saveUploadData(array2, uniqueId, 1, 1, "txt", "field", 1);

        $('#processing-data').modal({
            backdrop: 'static',
        });

    }
   
}

function saveUploadData(upload, uniqueId, totalBatch, statusBatch, dataType, type, totalData ){
    $.ajax({
        url: "{{ path('datahub_upload') }}",
        async: true,
        type: "GET",
        dataType: "json",
        data: { "upload":upload, "uniqueId":uniqueId, "statusBatch":statusBatch, "type":type, "dataType":dataType, "totalData":totalData},	
        contentType: "application/json"               
    }).done(function (data) {
        console.log("data "+data.message);
        if(type != "header"){
            var currentBatch = parseInt($("#current-batch").val());
            var nextBatch = currentBatch+1;
            var percentage = nextBatch/totalBatch*100;
            var percent = percentage.toFixed(0);

            console.log("Percent "+percent);
            if(percent == 100){
                $("#processing-data-status").empty();
                $("#processing-data-status").text("Upload Data Processing");
                $("#processsing-percent>h3").empty();
                $("#processsing-percent>h3").text(percent+" %");
                console.log("percent uploading[finish] "+percent);
                console.log("unique Id final "+uniqueId);
                $("#processing-icon").css("display","none");
                $("#processing-finish").css("display","block");
                $("#upload-id").css("display","block");
                $("#upload-id").append("<div id='detail-upload'><h3>Upload Id <a href='/datahub/list?uploadId="+uniqueId+"'>"+uniqueId+"</a></h3></div>");
                $("#processing-close").css("display","block")
            }else{
                $("#processsing-percent>h3").empty();
                $("#processsing-percent>h3").text(percent+" %");
                console.log("percent uploading "+percent)

            }
            $("#current-batch").val(nextBatch);
        }
    }).fail(function (jqXHR, textStatus, errorThrown) {
            
    });
}

$("#processing-close").click(function(){
    $('.modal-backdrop').remove();
    $("#processing-icon").css("display","block");
    $("#processing-finish").css("display","none");
    $("#processsing-percent>h3").empty();
    $("#processsing-percent>h3").text("0%");
    $("#upload-id > div").remove();
    $("#current-batch").val(0);
    $("#processing-close").css("display","none")
});


</script>

   
  </body>
</html>
{% endblock %}
